FROM <%= from %>
USER root
RUN useradd -m -U -d <%= CIDE_DIR %> cide

# Install system build dependencies here

<% as_root.each do |cmd| -%>
RUN <%= cmd %>
<% end -%>

# Common

ENV HOME <%= CIDE_DIR %>
WORKDIR <%= CIDE_SRC_DIR %>

# Before

<% if before['run'] -%>
  <% before['forward_env'].to_a.each do |key| -%>
ENV <%= key %> <%= ENV[key] %>
  <% end %>
  <% before['add'].to_a.each do |file| -%>
ADD <%= file %> <%= File.expand_path(file, CIDE_SRC_DIR) %>
  <% end %>
ADD sshconfig <%= File.expand_path('config', CIDE_SSH_DIR) %>
RUN chmod 400 <%= File.expand_path('config', CIDE_SSH_DIR) %>
  <% if before['sshkey'] -%>
ADD <%= before['sshkey'] %> <%= File.expand_path('id_rsa', CIDE_SSH_DIR) %>
RUN chmod 400 <%= File.expand_path('id_rsa', CIDE_SSH_DIR) %>
  <% end %>
RUN chmod 755 <%= CIDE_SSH_DIR %>
RUN chown -R cide:cide <%= CIDE_DIR %>
USER cide
RUN <%= before['run'] %>
USER root
<% end -%>

# Add project data

ADD . <%= CIDE_SRC_DIR %>
RUN chown -R cide:cide <%= CIDE_DIR %>

# ENV

<% forward_env.to_a.each do |key| -%>
ENV <%= key %> <%= ENV[key] %>
<% end %>

# Test !

USER cide
RUN <%= run %>
